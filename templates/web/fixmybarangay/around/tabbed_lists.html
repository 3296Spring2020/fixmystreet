[% allow_creation = !c.cobrand.only_authed_can_create || (c.user && c.user.from_council);

IF allow_creation %]
<menu id="problems-nav" class="tab-nav">
    <ul>
        <li><a href="#current">Problems on the map</a></li>
        <li><a href="#message_manager">Problems via text</a></li>
    </ul>
</menu>
[% END %]
        
<ul id="current" class="issue-list-a tab">
    [% INCLUDE "around/on_map_list_items.html" %]
</ul>

[% IF allow_creation %]
<ul id="message_manager" class="issue-list-a tab">
	<li id="message-control">
		<div id="mm-username-container">username:&nbsp;<span id="mm-received-username"></span></div>
		<div id="mm-status-message-container">
			<div id="mm-status-message"></div>
		</div>
		<div id="mm-login-container">
			<div class="input text">
				<label for="mm-htauth-username">MM username</label>
				<input name="mm-htauth-username" id="mm-htauth-username" type="text"/>
			</div>
			<div class="input password">
				<label for="mm-htauth-password">Password</label>
				<input name="mm-htauth-password" id="mm-htauth-password" type="password"/>
			</div>
			<div class="submit">
				<input  id="available-submit" type="submit" value="Get available messages"/>
			</div>
		</div>
	</li>
	<li>
		<div id="mm-message-list" style="min-height:1em;"></div>
		</div>
	</li>
</ul>
<script type="text/javascript">
	
$(document).ready(function() {
		
	var mm_populate_list = function(data) {
		$('#mm-status-message-container').text("Got messages as " + data['username']);
		$('input[name=mm_text]').prop('checked', false); // uncheck all
	}
	
	
	var mm_selected_message = function(data) {
		var msg_text = "";
		if (data['success']) {
			msg_text = data['data']['Message']['message'];
			// $('#form_detail').val( $('input[name=mm_text]:checked').val() );
		} else {
			$('input[name=mm_text]').prop('checked', false); // uncheck all
		}
		$('#form_detail').val(msg_text);
	}
	
	message_manager.config({url_root: "http://dave.message-manager.dev.mysociety.org/"});

	message_manager.setup_click_listener({callback:mm_selected_message});
	
	$('#available-submit').click(function(e){
		e.preventDefault();
		message_manager.get_available_messages({callback:mm_populate_list});		
	});

	// submit available-submit on page load if we have a username
	
	/*
	$('#assign-fms-submit').click(function() {
		message_manager.assign_fms_id($('#message_id').val(), $('#fms_id').val(), {callback:dummy_clear_assign_boxes});
	});
	*/
});
	
</script>
[% END %]
