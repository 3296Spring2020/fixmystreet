[%

    rss_alt   = loc('RSS feed');
    rss_title = loc('RSS feed of recent local problems');

    rss_url
        = pc
        ? c.uri_for( "/rss/pc", pc )
        : c.uri_for( "/rss/l/$short_latitude,$short_longitude" );
            
    email_url = c.uri_for(
        '/alert',
        {
            lat  => short_latitude,
            lon  => short_longitude,
            feed => "local:$short_latitude:$short_longitude",
        }
    );

    url_skip = c.uri_for(
        '/report/new',
        {
            pc         => pc
            latitude   => short_latitude,
            longitude  => short_longitude,
            submit_map => 1,
            skipped    => 1,
        }
    );

    INCLUDE 'header.html',
        title  => loc('Viewing a location')
        rss    => [ loc('Recent local problems, FixMyStreet'), rss_url ],
        robots => 'noindex,nofollow';
%]

[% map_html %]

<h1>[% loc('Problems in this area') %]</h1>

<p id="alert_links_area">
    <a id="email_alert" rel="nofollow" href="[% email_url | html %]">
        [% loc('Email me new local problems') %]
    </a> |
    <a href="[% rss_url | html %]" id="rss_alert">
        <span>[% rss_alt %]</span>
        <img src="/i/feed.png" width="16" height="16" title="[% rss_title %]" alt="[% rss_alt %]" border="0" style="vertical-align: top">
    </a>
</p>

[% IF pc_error %]
    <ul class="error">
        <li>[% pc_error | html %]</li>
    </ul>
[% END %]

<p id="text_map">
    [% loc( 'To report a problem, simply <strong>click on the map</strong> at the correct location.' ) %]
    [%
        tprintf(
            loc("<small>If you cannot see the map, <a href='%s' rel='nofollow'>skip this step</a>.</small>"),
            url_skip
        )
    %]
</p>

<div id="nearby_lists">

    <h2>[% loc('Reports on and around the map') %]</h2>
    
    <ul id="current">
        [% IF on_map.size %]
            [% FOREACH p IN on_map %]
                <li>
                    <a href="[% c.uri_for('/report', p.id ) %]">
                        [% p.title | html %]
                    </a>
                    <small>([% prettify_epoch( p.time, 1 ) %])</small>
                    [% IF p.state == 'fixed' %]
                        <small>[% loc('(fixed)') %]</small>
                    [% END %]
                </li>
            [% END %]
        [% ELSE %]
            <li>[% loc('No problems have been reported yet.') %]</li>
        [% END %]
    </ul>
    

    <h2 id="closest_problems">
        [%
            tprintf(
                loc( 'Closest nearby problems <small>(within&nbsp;%skm)</small>' ),
                distance
            )
        %]
    </h2>
    
    <ul id="current_near">
        [% IF around_map.size %]
            [% FOREACH p IN around_map %]

                [% dist = int( p.distance * 10 + 0.5 ) / 10 %]
                
                <li>
                    <a href="[% c.uri_for('/report', p.id ) %]">
                        [% p.title | html %]
                    </a>
                    <small>([% prettify_epoch( p.time, 1 ) %], [% dist %]km)</small>)</small>
                    [% IF p.state == 'fixed' %]
                        <small>[% loc('(fixed)') %]</small>
                    [% END %]
                </li>
            [% END %]
        [% ELSE %]
            <li>[% loc('No problems found.') %]</li>
        [% END %]
    </ul>

</div>

[% map_end_html %]

[% INCLUDE 'footer.html' %]
