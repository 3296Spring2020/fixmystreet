[% INCLUDE 'admin/header.html' title=loc('Search Reports') %]

[% BLOCK value_or_nbsp -%]
    [%- IF value %][% value | html %][% ELSE %]&nbsp;[% END %]
[%- END %]

[% BLOCK format_time -%]
    [%- IF time %][% time.ymd %]&nbsp;[% time.hms %][% ELSE %]&nbsp;[% END %]
[%- END %]

<form method="get" action="[% c.uri_for('search_reports') %]" enctype="application/x-www-form-urlencoded" accept-charset="utf-8">
    <label for="search">Search:</label> <input type="text" name="search"  size="30" id="search">
</form>


[% IF searched %]
<table cellspacing="0" cellpadding="2" border="1">
    <tr>
        <th>[% loc('ID') %]</th>
        <th>[% loc('Title') %]</th>
        <th>[% loc('Name') %]</th>
        <th>[% loc('Email') %]</th>
        <th>[% loc('Council') %]</th>
        <th>[% loc('Category') %]</th>
        <th>[% loc('Anonymous') %]</th>
        <th>[% loc('Cobrand') %]</th>
        <th>[% loc('Created') %]</th>
        <th>[% loc('State') %]</th>
        <th>[% loc('When sent') %]</th>
        <th>[% loc('*') %]</th>
    </tr>
[%- FOREACH problem IN problems %]
    <tr[% ' class="hidden"' IF problem.state == 'hidden' %]>
        <td>[%- IF problem.state == 'confirmed' || problem.state == 'fixed' -%]
        [%- cobrand_data = problem.cobrand_data %]
        [%- cobrand_data = c.data_for_generic_problem IF !problem.cobrand %]
        <a href="[% c.uri_for_email( '/report', problem.id, cobrand_data ) %]">[% problem.id %]</a>
        [%- ELSE %]
        [%- problem.id %]
        [%- END -%]</td> 
        <td>[% PROCESS value_or_nbsp value=problem.title %]</td> 
        <td>[% PROCESS value_or_nbsp value=problem.name %]</td> 
        <td>[% PROCESS value_or_nbsp value=problem.user.email %]</td> 
        <td>[%- IF edit_council_contacts -%]
        <a href="[% c.uri_for('council_contacts', problem.council ) %]">[% PROCESS value_or_nbsp value=problem.council %]</a>
        [%- ELSE -%]
            [%- PROCESS value_or_nbsp value=problem.council -%]
        [%- END -%]</td>
        <td>[% PROCESS value_or_nbsp value=problem.category %]</td> 
        <td>[% IF problem.anonymous %][% loc('Yes') %][% ELSE %][% loc('No') %][% END %]</td> 
        <td>[% problem.cobrand %]<br>[% problem.cobrand_data | html %]</td> 
        <td>[% PROCESS format_time time=problem.created %]</td> 
        <td>[% problem.state %]<small>
                [%- IF problem.state == 'fixed' || problem.state == 'confirmed' %]<br>[% loc('Confirmed:' ) %]&nbsp;[% PROCESS format_time time=problem.confirmed %][% END -%]
                [%- IF problem.state == 'fixed' %]<br>[% loc('Fixed:') %] [% PROCESS format_time time=problem.lastupdate %][% END -%]
                [%- IF problem.state == 'confirmed' %]<br>[% loc('Last&nbsp;update:') %] [% PROCESS format_time time=problem.lastupdate %][% END -%]</small>
        </td> 
        <td>[% PROCESS format_time time=problem.whensent %]</td> 
        <td><a href="[% c.uri_for( 'report_edit', problem.id ) %]">Edit</a></td>
    </tr>
[%- END -%]
</table>

<h2>Updates</h2>

<table cellspacing="0" cellpadding="2" border="1">
    <tr>
        <th>[% loc('ID') %]</th>
        <th>[% loc('State') %]</th>
        <th>[% loc('Name') %]</th>
        <th>[% loc('Email') %]</th>
        <th>[% loc('Created') %]</th>
        <th>[% loc('Anonymous') %]</th>
        <th>[% loc('Cobrand') %]</th>
        <th>[% loc('Text') %]</th>
        <th>[% loc('*') %]</th>
    </tr>
[% FOREACH update IN updates -%]
    <tr[% ' class="hidden"' IF update.state == 'hidden' || ( problem.state && problem.state == 'hidden' ) %]>
        <td>[%- IF update.state == 'confirmed' -%]
        [%- cobrand_data = update.cobrand_data %]
        [%- cobrand_data = c.data_for_generic_update IF !update.cobrand %]
        <a href="[% c.uri_for_email( '/report', update.problem.id, cobrand_data ) %]#update_[% update.id %]">[% update.id %]</a>
        [%- ELSE %]
        [%- update.id %]
        [%- END -%]</td> 
        <td>[% update.state %]</td> 
        <td>[% update.name | html %]</td> 
        <td>[% update.user.email | html %]</td> 
        <td>[% PROCESS format_time time=update.created %]</td> 
        <td>[% IF update.anonymous %][% loc('Yes') %][% ELSE %][% loc('No') %][% END %]</td> 
        <td>[% update.cobrand %]<br>[% update.cobrand_data | html %]</td> 
        <td>[% update.text | html %]</td> 
        <td><a href="[% c.uri_for( 'update_edit', update.id ) %]">Edit</a></td>
    <tr>
[% END -%]
</table>
[% END %]

[% INCLUDE 'admin/footer.html' %]
